<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAVI - AI ì‘ë‹µ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="page page4">
        <!-- ì™¼ìª½ ìƒë‹¨ NAVI ê¸€ì ë¡œê³  -->
        <a href="index.html" class="logo-text-only" style="text-decoration: none; color: #1a3c8c;">NAVI</a>
        
        <main class="chat-content-new">
            <!-- ì‚¬ìš©ì ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½) -->
            <div class="user-message-right">
                <p id="userPrompt">í”„ë¡¬í”„íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>

            <!-- AI ì‘ë‹µ ìƒì„±ì¤‘ (ì™¼ìª½) -->
            <div class="ai-message-left" id="loadingMessage">
                <div class="ai-profile">
                    <img src="images/logo_navi.svg" alt="NAVI">
                </div>
                <div class="ai-message-content">
                    <span id="loadingText">AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘</span>
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <!-- AI ìµœì¢… ì‘ë‹µ (ì™¼ìª½, ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
            <div class="ai-response-left" id="finalResponse" style="display: none;">
                <div class="ai-profile">
                    <img src="images/logo_navi.svg" alt="NAVI">
                </div>
                <div class="ai-response-content" id="aiResponseContent">
                    <p>ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </main>

        <!-- í•˜ë‹¨ ë¡œê³ ë“¤ (ë‹µë³€ ìƒì„± í›„ì—ë§Œ í‘œì‹œ) -->
        <div class="bottom-logos" id="bottomLogos" style="display: none;">
            <p class="bottom-text">ë‹¹ì‹ ì—ê²Œ ë”± ë§ëŠ” AI ë„êµ¬ì˜ ê¸¸ë¡œ ì•ˆë‚´í•´ìš”</p>
            <div class="ai-logos-bottom">
                <img src="images/perplexity-logo.png" alt="Perplexity">
                <img src="images/gemini-logo.png" alt="Gemini">
                <img src="images/chatgpt-logo.png" alt="ChatGPT">
                <img src="images/claude-logo.png" alt="Claude">
                <img src="images/gamma-logo.png" alt="Gamma">
            </div>
        </div>

        <!-- í‘¸í„° (ë‹µë³€ ìƒì„± í›„ì—ë§Œ í‘œì‹œ) -->
        <footer id="footerSection" style="display: none;">
            <div class="footer-logo-icon">
                <img src="images/logo_navi_black.svg" alt="NAVI" style="height: 40px;">
            </div>
            <p class="footer-tagline">ìƒí™©ë³„ ìµœì  AI íˆ´ ê°€ì´ë“œ</p>
            <p class="footer-copyright">All right reserved Â© 2025 NAVI IVAN</p>
            <div class="footer-links">
                <a href="#">ì†Œê°œ</a>
                <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                <a href="#">ì´ìš©ì•½ê´€</a>
                <a href="#">ë¬¸ì˜í•˜ê¸°</a>
            </div>
        </footer>
    </div>

    <script>
    console.log('========================================');
    console.log('ğŸš€ Page 4 ë¡œë“œë¨');
    console.log('========================================');

    window.addEventListener('DOMContentLoaded', function() {
        // 1. ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        const selectedAI = localStorage.getItem('selectedAI');
        const selectedPrompt = localStorage.getItem('selectedPrompt');
        const selectedToolUrl = localStorage.getItem('selectedToolUrl');
        const aiResultRaw = localStorage.getItem('aiResult');
        
        console.log('ğŸ“¦ ì €ì¥ëœ ë°ì´í„°:');
        console.log('  - selectedAI:', selectedAI);
        console.log('  - selectedPrompt:', selectedPrompt);
        console.log('  - aiResult:', aiResultRaw);
        
        // 2. ë°ì´í„° ì—†ìœ¼ë©´ page2ë¡œ ì´ë™
        if (!selectedPrompt) {
            alert('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. Page 2ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
            window.location.href = 'page2.html';
            return;
        }
        
        // 3. ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        document.getElementById('userPrompt').textContent = selectedPrompt;
        
        // 4. ë¡œë”© ë©”ì‹œì§€ì— AI ì´ë¦„ í‘œì‹œ
        document.getElementById('loadingText').textContent = 
            `${selectedAI || 'AI'}ì´(ê°€) ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘`;
        
        // 5. AI ì‘ë‹µ ì²˜ë¦¬
        if (aiResultRaw) {
            try {
                const aiResult = JSON.parse(aiResultRaw);
                console.log('âœ… AI ì‘ë‹µ íŒŒì‹± ì™„ë£Œ:', aiResult);
                
                // ì‹¤ì œ API ì‘ë‹µ í‘œì‹œ
                displayAIResponse(selectedAI, aiResult);
                
            } catch (error) {
                console.error('âŒ AI ì‘ë‹µ íŒŒì‹± ì—ëŸ¬:', error);
                displayErrorResponse(selectedAI, selectedPrompt);
            }
        } else {
            console.log('âš ï¸ AI ì‘ë‹µ ì—†ìŒ - ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ');
            displayErrorResponse(selectedAI, selectedPrompt);
        }
    });

    /**
     * ì‹¤ì œ API ì‘ë‹µì„ í™”ë©´ì— í‘œì‹œ
     */
    function displayAIResponse(aiName, result) {
        console.log('ğŸ¨ AI ì‘ë‹µ í‘œì‹œ ì¤‘...');
        
        // ë¡œë”© ìˆ¨ê¸°ê³  ì‘ë‹µ í‘œì‹œ
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('finalResponse').style.display = 'flex';
        document.getElementById('bottomLogos').style.display = 'block';
        document.getElementById('footerSection').style.display = 'block';
        
        // ì‘ë‹µ ë‚´ìš© ì¶”ì¶œ
        let responseText = '';
        
        // ë°±ì—”ë“œ ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ì²˜ë¦¬
        // result.responseê°€ { type: "text", text: "..." } í˜•íƒœ
        if (result.response) {
            if (typeof result.response === 'string') {
                responseText = result.response;
            } else if (result.response.type === 'text') {
                responseText = result.response.text;
            } else if (result.response.type === 'multimodal') {
                // ë©€í‹°ëª¨ë‹¬ ì‘ë‹µ ì²˜ë¦¬
                responseText = result.response.content
                    .filter(item => item.type === 'text')
                    .map(item => item.text)
                    .join('\n\n');
                    
                // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì¶”ê°€
                const images = result.response.content.filter(item => item.type === 'image');
                if (images.length > 0) {
                    responseText += '\n\n[ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤]';
                }
            }
        } else if (result.text) {
            responseText = result.text;
        } else if (result.message) {
            responseText = result.message;
        }
        
        console.log('ğŸ“ ì¶”ì¶œëœ ì‘ë‹µ:', responseText.substring(0, 100) + '...');
        
        // ì‘ë‹µ HTML ìƒì„±
        const responseContent = document.getElementById('aiResponseContent');
        
        // ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ë³€í™˜ (ê°„ë‹¨í•œ ë²„ì „)
        let formattedResponse = formatResponse(responseText, aiName);
        
        responseContent.innerHTML = formattedResponse;
        
        console.log('âœ… AI ì‘ë‹µ í‘œì‹œ ì™„ë£Œ');
    }

    /**
     * ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ í¬ë§·
     */
    function formatResponse(text, aiName) {
        if (!text) {
            return `<p>${aiName || 'AI'}ì˜ ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
        
        // ì¤„ë°”ê¿ˆì„ <br> ë˜ëŠ” <p>ë¡œ ë³€í™˜
        let html = '';
        
        // ì œëª© íŒ¨í„´ ê°ì§€ (1. 2. 3. ë˜ëŠ” **ì œëª©**)
        const lines = text.split('\n');
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) {
                html += '<br>';
                return;
            }
            
            // ë²ˆí˜¸ ì œëª© (1. 2. 3.)
            if (/^\d+\.\s/.test(line)) {
                html += `<h3>${line}</h3>`;
            }
            // í•´ì‹œíƒœê·¸
            else if (line.startsWith('#') && !line.startsWith('##')) {
                html += `<p class="hashtag">${line}</p>`;
            }
            // ì¼ë°˜ í…ìŠ¤íŠ¸
            else {
                html += `<p>${line}</p>`;
            }
        });
        
        return html;
    }

    /**
     * ì—ëŸ¬ ì‹œ í‘œì‹œí•  ë©”ì‹œì§€
     */
    function displayErrorResponse(aiName, prompt) {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('finalResponse').style.display = 'flex';
        document.getElementById('bottomLogos').style.display = 'block';
        document.getElementById('footerSection').style.display = 'block';
        
        const responseContent = document.getElementById('aiResponseContent');
        responseContent.innerHTML = `
            <p>âš ï¸ AI ì‘ë‹µì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <p>ì…ë ¥í•˜ì‹  í”„ë¡¬í”„íŠ¸: "${prompt}"</p>
            <br>
            <p>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
            <button onclick="window.location.href='page3.html'" 
                    style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">
                â† ë‹¤ì‹œ ì‹œë„í•˜ê¸°
            </button>
        `;
    }

    console.log('âœ… Page 4 ì´ˆê¸°í™” ì™„ë£Œ');
    </script>
</body>
</html>